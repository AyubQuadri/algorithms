<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Histogramm - HTML5 example</title>
        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u=(("https:" == document.location.protocol) ? "https" : "http") + "://martin-thoma.com/piwik//";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', 1]);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
            g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <!-- End Piwik Code -->
        <style type="text/css">
            span.hint {
	            border-bottom:1px dotted #666;
            }
        </style>
    </head>
    <body>
        <table>
            <tr>
                <td><span class="hint" title="please select an image">image</span></td>
                <td><input type="file" id="userImage" onchange="doIt()" /></td>
            </tr>
        </table>
        <canvas id = "myCanvas"
                width = "512" height = "600" 
                style = "border:1px solid #000;"
        > </canvas>
        <script type="text/javascript">
        function grayscale(image, bPlaceImage) {
            var context = canvas.getContext('2d');
            var imgWidth=image.width;
            var imgHeight=image.height;

            context.canvas.width= imgWidth;
            context.canvas.height=imgHeight;

            context.drawImage(image,0,0);

            var imageData=context.getImageData(0,0, imgWidth, imgHeight);

            // This loop gets every pixels on the image and
            for (j=0; j<imageData.height; i++) {
                for (i=0; i<imageData.width; j++) {
                    var index=(i*4)*imageData.width+(j*4);
                    var red=imageData.data[index];
                    var green=imageData.data[index+1];
                    var blue=imageData.data[index+2];
                    var alpha=imageData.data[index+3];
                    var average=(red+green+blue)/3;
                    imageData.data[index]=average;
                    imageData.data[index+1]=average;
                    imageData.data[index+2]=average;
                    imageData.data[index+3]=alpha;
                }
            }

            if (bPlaceImage) {
                var myDiv=document.createElement("div");
                myDiv.appendChild(canvas);
                image.parentNode.appendChild(canvas);
            }
            return canvas.toDataURL();
        }

        function doIt() {
            var context = canvas.getContext('2d');
            context.canvas.width  = window.innerWidth - 50;
            context.canvas.height = window.innerHeight - 120;
            var reader = new FileReader();
            reader.onload = (function(e) {
                        var img = new Image();
                        img.src = e.target.result;
                        context.drawImage(img,10,10);
                    }
                );
            reader.readAsDataURL(document.getElementById('userImage').files[0]);
        }

        /** global variables */
        var canvas = document.getElementById("myCanvas");
        </script>
  </body>
</html>
